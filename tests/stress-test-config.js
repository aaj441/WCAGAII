const StressTest = require('../backend/src/stress-test');
const verticals = require('./verticals.json');
const fs = require('fs').promises;
const path = require('path');

// Parse command-line arguments
const args = process.argv.slice(2);
const duration = args.includes('--duration')
  ? parseInt(args[args.indexOf('--duration') + 1])
  : 3600; // Default 1 hour

const concurrency = args.includes('--concurrency')
  ? parseInt(args[args.indexOf('--concurrency') + 1])
  : 5;

const vertical = args.includes('--vertical')
  ? args[args.indexOf('--vertical') + 1]
  : 'all';

// Get URLs based on vertical selection
function getTestUrls() {
  if (vertical === 'all') {
    // Combine all URLs from all verticals
    return Object.values(verticals).flat();
  } else if (verticals[vertical]) {
    return verticals[vertical];
  } else {
    console.error(`Unknown vertical: ${vertical}`);
    console.log('Available verticals:', Object.keys(verticals).join(', '));
    process.exit(1);
  }
}

// Generate report
async function generateReport(results) {
  const report = `# WCAGAI v3.0 Stress Test Report

## Test Configuration
- **Duration:** ${duration} seconds (${(duration / 60).toFixed(1)} minutes)
- **Concurrency:** ${concurrency}
- **Vertical:** ${vertical}
- **Total URLs:** ${results.totalScans}
- **Timestamp:** ${new Date().toISOString()}

## Results Summary
- **Total Scans:** ${results.totalScans}
- **Successful Scans:** ${results.successfulScans}
- **Failed Scans:** ${results.failedScans}
- **Success Rate:** ${((results.successfulScans / results.totalScans) * 100).toFixed(2)}%

## Performance Metrics
- **Average Scan Time:** ${results.averageTime.toFixed(2)}ms
- **Min Scan Time:** ${results.minTime}ms
- **Max Scan Time:** ${results.maxTime}ms
- **Scans Per Minute:** ${results.scansPerMinute.toFixed(2)}

## System Performance
- **Memory Usage:** ${JSON.stringify(process.memoryUsage(), null, 2)}
- **CPU Time:** ${JSON.stringify(process.cpuUsage(), null, 2)}

## Error Analysis
${results.errors.length > 0 ? `
Total Errors: ${results.errors.length}

### Error Breakdown
${results.errors.slice(0, 20).map((err, idx) => `
${idx + 1}. **${err.url}**
   - Error: ${err.error}
   - Time: ${err.timestamp}
`).join('\n')}

${results.errors.length > 20 ? `\n*Showing first 20 of ${results.errors.length} errors*` : ''}
` : 'No errors encountered during stress test.'}

## Conclusion
${results.successfulScans / results.totalScans >= 0.95
  ? '‚úÖ **PASS** - System performance is excellent (95%+ success rate)'
  : results.successfulScans / results.totalScans >= 0.90
  ? '‚ö†Ô∏è **WARNING** - System performance is acceptable but needs improvement (90-95% success rate)'
  : '‚ùå **FAIL** - System performance is below acceptable levels (<90% success rate)'}

---
Generated by WCAGAI v3.0 Stress Test Suite
`;

  const reportPath = path.join(__dirname, `../docs/stress-test-report-${Date.now()}.md`);
  await fs.writeFile(reportPath, report);
  console.log(`\nüìÑ Report saved to: ${reportPath}`);
}

// Main execution
async function main() {
  console.log('üöÄ WCAGAI v3.0 Comprehensive Stress Test');
  console.log('==========================================');
  console.log(`Duration: ${duration}s (${(duration / 60).toFixed(1)} minutes)`);
  console.log(`Concurrency: ${concurrency}`);
  console.log(`Vertical: ${vertical}`);
  console.log('==========================================\n');

  const urls = getTestUrls();
  console.log(`Testing ${urls.length} unique URLs\n`);

  const test = new StressTest({
    duration,
    concurrency,
    urls
  });

  try {
    const results = await test.run();
    await generateReport(results);

    // Exit with appropriate code
    const successRate = results.successfulScans / results.totalScans;
    if (successRate < 0.90) {
      console.log('\n‚ùå Stress test FAILED - Success rate below 90%');
      process.exit(1);
    } else {
      console.log('\n‚úÖ Stress test PASSED');
      process.exit(0);
    }
  } catch (error) {
    console.error('Stress test encountered a fatal error:', error);
    process.exit(1);
  }
}

main();
