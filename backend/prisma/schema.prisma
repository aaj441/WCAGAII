// Prisma Schema for WCAGAI v3.0
// Database: PostgreSQL with Read Replicas
// Features: Scan history, user management, audit logs

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["multiSchema", "postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [uuid_ossp]
}

// User Model
model User {
  id            String   @id @default(uuid()) @db.Uuid
  email         String   @unique
  name          String?
  apiKey        String   @unique @map("api_key")
  apiKeyHash    String   @map("api_key_hash")
  plan          String   @default("free") // free, pro, enterprise
  requestLimit  Int      @default(100) @map("request_limit")
  requestCount  Int      @default(0) @map("request_count")
  active        Boolean  @default(true)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  scans         Scan[]
  auditLogs     AuditLog[]

  @@map("users")
  @@index([email])
  @@index([apiKey])
}

// Scan Model
model Scan {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String?  @map("user_id") @db.Uuid
  type            String   // url, html
  input           String   @db.Text
  url             String?  @db.Text

  // Results
  violationsCount Int      @default(0) @map("violations_count")
  passesCount     Int      @default(0) @map("passes_count")
  incompleteCount Int      @default(0) @map("incomplete_count")
  wcagLevel       String   @default("AA") @map("wcag_level")

  // Performance
  duration        Int      // milliseconds
  scanDate        DateTime @default(now()) @map("scan_date") @db.Timestamptz(6)

  // Metadata
  userAgent       String?  @map("user_agent") @db.Text
  viewport        Json?
  options         Json?

  // Results storage
  violations      Json?    // Full violation data
  passes          Json?    // Full pass data
  incomplete      Json?    // Incomplete rules data

  // AI Enhancement
  aiRecommendations String? @map("ai_recommendations") @db.Text

  // Relations
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@map("scans")
  @@index([userId])
  @@index([scanDate])
  @@index([type])
  @@index([wcagLevel])
}

// Audit Log Model
model AuditLog {
  id              String   @id @default(uuid()) @db.Uuid
  userId          String?  @map("user_id") @db.Uuid
  eventType       String   @map("event_type") // scan, auth, config, error
  eventAction     String   @map("event_action")
  resourceType    String?  @map("resource_type")
  resourceId      String?  @map("resource_id")

  // Request details
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent") @db.Text
  correlationId   String?  @map("correlation_id")

  // Event data
  metadata        Json?
  success         Boolean  @default(true)
  errorMessage    String?  @map("error_message") @db.Text

  // Relations
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  timestamp       DateTime @default(now()) @db.Timestamptz(6)

  @@map("audit_logs")
  @@index([userId])
  @@index([eventType])
  @@index([timestamp])
  @@index([correlationId])
}

// System Health Model
model SystemHealth {
  id              String   @id @default(uuid()) @db.Uuid
  service         String   // browser-pool, redis, database, api
  status          String   // healthy, degraded, unhealthy

  // Metrics
  cpu             Float?
  memory          Float?
  requestCount    Int?     @map("request_count")
  errorCount      Int?     @map("error_count")
  avgLatency      Float?   @map("avg_latency")

  metadata        Json?
  timestamp       DateTime @default(now()) @db.Timestamptz(6)

  @@map("system_health")
  @@index([service])
  @@index([timestamp])
}

// API Key Usage Model
model ApiKeyUsage {
  id              String   @id @default(uuid()) @db.Uuid
  apiKey          String   @map("api_key")
  endpoint        String
  method          String
  statusCode      Int      @map("status_code")
  duration        Int      // milliseconds
  timestamp       DateTime @default(now()) @db.Timestamptz(6)

  @@map("api_key_usage")
  @@index([apiKey])
  @@index([timestamp])
}
