name: Stress Test CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run stress test every day at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      duration:
        description: 'Test duration in seconds'
        required: false
        default: '300'
      concurrency:
        description: 'Number of concurrent workers'
        required: false
        default: '5'
      vertical:
        description: 'Vertical to test (all, ecommerce, news, etc.)'
        required: false
        default: 'all'

jobs:
  stress-test:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json

    - name: Install Chromium dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          fonts-liberation \
          libasound2 \
          libatk-bridge2.0-0 \
          libatk1.0-0 \
          libatspi2.0-0 \
          libcups2 \
          libdbus-1-3 \
          libdrm2 \
          libgbm1 \
          libgtk-3-0 \
          libnspr4 \
          libnss3 \
          libwayland-client0 \
          libxcomposite1 \
          libxdamage1 \
          libxfixes3 \
          libxkbcommon0 \
          libxrandr2 \
          xdg-utils

    - name: Install backend dependencies
      working-directory: ./backend
      run: PUPPETEER_SKIP_DOWNLOAD=true npm ci

    - name: Create environment file
      working-directory: ./backend
      run: |
        cp .env.example .env
        echo "PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser" >> .env

    - name: Start backend server
      working-directory: ./backend
      run: |
        npm start &
        echo $! > server.pid
        sleep 10

    - name: Wait for backend to be ready
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:8000/health; then
            echo "Backend is ready"
            exit 0
          fi
          echo "Waiting for backend... ($i/30)"
          sleep 2
        done
        echo "Backend failed to start"
        exit 1

    - name: Run quick stress test (1 minute for CI)
      if: github.event_name != 'workflow_dispatch'
      working-directory: ./tests
      run: |
        node stress-test-config.js \
          --duration=60 \
          --concurrency=3 \
          --vertical=technology

    - name: Run custom stress test
      if: github.event_name == 'workflow_dispatch'
      working-directory: ./tests
      run: |
        node stress-test-config.js \
          --duration=${{ github.event.inputs.duration }} \
          --concurrency=${{ github.event.inputs.concurrency }} \
          --vertical=${{ github.event.inputs.vertical }}

    - name: Upload stress test reports
      if: always()
      uses: actions/upload-artifact@v4
            with:name:
                    stress-test-reports-node-${{ matrix.node-version }}
        path: docs/stress-test-report-*.md
        retention-days: 30

    - name: Stop backend server
      if: always()
      working-directory: ./backend
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
          rm server.pid
        fi

    - name: Upload backend logs
      if: failure()
      uses: actions/upload-artifact@v4
            with:name:
                    backend-logs-node-${{ matrix.node-version }}
        path: backend/*.log
        retention-days: 7

  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18.x

    - name: Install dependencies
      working-directory: ./backend
      run: PUPPETEER_SKIP_DOWNLOAD=true npm ci

    - name: Check for syntax errors
      working-directory: ./backend
      run: |
        node -c src/server.js
        node -c src/scanner.js
        node -c src/stress-test.js
        node -c src/config.js

  security:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18.x

    - name: Install dependencies for audit
      working-directory: ./backend
      run: PUPPETEER_SKIP_DOWNLOAD=true npm ci

    - name: Run npm audit
      working-directory: ./backend
      run: npm audit --production --audit-level=moderate || true

    - name: Check for private IP protection
      run: |
        if grep -r "isPrivateIP" backend/src/scanner.js; then
          echo "✓ SSRF protection found"
        else
          echo "✗ SSRF protection missing"
          exit 1
        fi
